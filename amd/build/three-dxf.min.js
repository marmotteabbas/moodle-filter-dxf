define(["filter_dxf/three","filter_dxf/OrbitControls","jquery"],function(a,b,c){a.Math.angle2=function(b,c){var d=new a.Vector2(b.x,b.y),e=new a.Vector2(c.x,c.y);return e.sub(d),e.normalize(),e.y<0?-Math.acos(e.x):Math.acos(e.x)},a.Math.polar=function(a,b,c){var d={};return d.x=a.x+b*Math.cos(c),d.y=a.y+b*Math.sin(c),d},a.BulgeGeometry=function(b,c,d,e){var f,g,h,i,j,k,l,m,n;for(a.Geometry.call(this),this.startPoint=i=b?new a.Vector2(b.x,b.y):new a.Vector2(0,0),this.endPoint=j=c?new a.Vector2(c.x,c.y):new a.Vector2(1,0),this.bulge=d=d||1,k=4*Math.atan(d),l=i.distanceTo(j)/2/Math.sin(k/2),h=a.Math.polar(b,l,a.Math.angle2(i,j)+(Math.PI/2-k/2)),this.segments=e=e||Math.max(Math.abs(Math.ceil(k/(Math.PI/18))),6),m=a.Math.angle2(h,i),n=k/e,this.vertices.push(new a.Vector3(i.x,i.y,0)),g=1;g<=e-1;g++)f=a.Math.polar(h,Math.abs(l),m+n*g),this.vertices.push(new a.Vector3(f.x,f.y,0))},a.BulgeGeometry.prototype=Object.create(a.Geometry.prototype);var d={};return d.Viewer=function(b,d,e,f,g){function h(a,b){var c;return"CIRCLE"===a.type||"ARC"===a.type?c=m(a,b):"LWPOLYLINE"===a.type||"LINE"===a.type||"POLYLINE"===a.type?c=l(a,b):"TEXT"===a.type?c=o(a,b):"SOLID"===a.type?c=n(a,b):"POINT"===a.type?c=p(a,b):"INSERT"===a.type?c=q(a,b):"SPLINE"===a.type?c=k(a,b):"MTEXT"===a.type?c=j(a,b):"ELLIPSE"===a.type?c=i(a,b):console.log("Unsupported Entity Type: "+a.type),c}function i(b,c){var d=r(b,c),e=Math.sqrt(Math.pow(b.majorAxisEndPoint.x,2)+Math.pow(b.majorAxisEndPoint.y,2)),f=e*b.axisRatio,g=Math.atan2(b.majorAxisEndPoint.y,b.majorAxisEndPoint.x),h=new a.EllipseCurve(b.center.x,b.center.y,e,f,b.startAngle,b.endAngle,(!1),g),i=h.getPoints(50),j=(new a.BufferGeometry).setFromPoints(i),k=new a.LineBasicMaterial({linewidth:1,color:d}),l=new a.Line(j,k);return l}function j(b,c){var d=r(b,c),e=new a.TextGeometry(b.text,{font:g,size:.8*b.height,height:1}),f=new a.MeshBasicMaterial({color:d}),h=new a.Mesh(e,f),i=new a.Box3;i.setFromObject(h);var j=i.max.x-i.min.x;if(j>b.width)return void console.log("Can't render this multipline MTEXT entity, sorry.",b);switch(h.position.z=0,b.attachmentPoint){case 1:h.position.x=b.position.x,h.position.y=b.position.y-b.height;break;case 2:h.position.x=b.position.x-j/2,h.position.y=b.position.y-b.height;break;case 3:h.position.x=b.position.x-j,h.position.y=b.position.y-b.height;break;case 4:h.position.x=b.position.x,h.position.y=b.position.y-b.height/2;break;case 5:h.position.x=b.position.x-j/2,h.position.y=b.position.y-b.height/2;break;case 6:h.position.x=b.position.x-j,h.position.y=b.position.y-b.height/2;break;case 7:h.position.x=b.position.x,h.position.y=b.position.y;break;case 8:h.position.x=b.position.x-j/2,h.position.y=b.position.y;break;case 9:h.position.x=b.position.x-j,h.position.y=b.position.y;break;default:return}return h}function k(b,c){var d=r(b,c),e=b.controlPoints.map(function(b){return new a.Vector2(b.x,b.y)}),f=[];if(2===b.degreeOfSplineCurve||3===b.degreeOfSplineCurve)for(var g=0;g+2<e.length;g+=2)2===b.degreeOfSplineCurve?curve=new a.QuadraticBezierCurve(e[g],e[g+1],e[g+2]):curve=new a.QuadraticBezierCurve3(e[g],e[g+1],e[g+2]),f.push.apply(f,curve.getPoints(50));else curve=new a.SplineCurve(e),f=curve.getPoints(100);var h=(new a.BufferGeometry).setFromPoints(f),i=new a.LineBasicMaterial({linewidth:1,color:d}),j=new a.Line(h,i);return j}function l(b,c){var d,e,f,g,h,i,j,k,l,m=new a.Geometry,n=r(b,c);for(k=0;k<b.vertices.length;k++)b.vertices[k].bulge?(j=b.vertices[k].bulge,g=b.vertices[k],h=k+1<b.vertices.length?b.vertices[k+1]:m.vertices[0],i=new a.BulgeGeometry(g,h,j),m.vertices.push.apply(m.vertices,i.vertices)):(f=b.vertices[k],m.vertices.push(new a.Vector3(f.x,f.y,0)));return b.shape&&m.vertices.push(m.vertices[0]),b.lineType&&(e=c.tables.lineType.lineTypes[b.lineType]),d=e&&e.pattern&&0!==e.pattern.length?new a.LineDashedMaterial({color:n,gapSize:4,dashSize:4}):new a.LineBasicMaterial({linewidth:1,color:n}),l=new a.Line(m,d)}function m(b,c){"CIRCLE"===b.type?(startAngle=b.startAngle||0,endAngle=startAngle+2*Math.PI):(startAngle=b.startAngle,endAngle=b.endAngle);var d=new a.ArcCurve(0,0,b.radius,startAngle,endAngle),e=d.getPoints(32),f=(new a.BufferGeometry).setFromPoints(e),g=new a.LineBasicMaterial({color:r(b,c)}),h=new a.Line(f,g);return h.position.x=b.center.x,h.position.y=b.center.y,h.position.z=b.center.z,h}function n(b,c){var d,e,f=new a.Geometry;e=f.vertices,e.push(new a.Vector3(b.points[0].x,b.points[0].y,b.points[0].z)),e.push(new a.Vector3(b.points[1].x,b.points[1].y,b.points[1].z)),e.push(new a.Vector3(b.points[2].x,b.points[2].y,b.points[2].z)),e.push(new a.Vector3(b.points[3].x,b.points[3].y,b.points[3].z));var g=new a.Vector3,h=new a.Vector3;return g.subVectors(e[1],e[0]),h.subVectors(e[2],e[0]),g.cross(h),g.z<0?(f.faces.push(new a.Face3(2,1,0)),f.faces.push(new a.Face3(2,3,1))):(f.faces.push(new a.Face3(0,1,2)),f.faces.push(new a.Face3(1,3,2))),d=new a.MeshBasicMaterial({color:r(b,c)}),new a.Mesh(f,d)}function o(b,c){var d,e,f;return g?(d=new a.TextGeometry(b.text,{font:g,height:0,size:b.textHeight||12}),e=new a.MeshBasicMaterial({color:r(b,c)}),f=new a.Mesh(d,e),f.position.x=b.startPoint.x,f.position.y=b.startPoint.y,f.position.z=b.startPoint.z,f):console.warn("Text is not supported without a Three.js font loaded with THREE.FontLoader! Load a font of your choice and pass this into the constructor. See the sample for this repository or Three.js examples at http://threejs.org/examples/?q=text#webgl_geometry_text for more details.")}function p(b,c){var d,e,f;d=new a.Geometry,d.vertices.push(new a.Vector3(b.position.x,b.position.y,b.position.z));var g=1,h=r(b,c),i=new Float32Array(3*g);i[0]=h.r,i[1]=h.g,i[2]=h.b,d.colors=i,d.computeBoundingBox(),e=new a.PointsMaterial({size:.05,vertexColors:a.VertexColors}),f=new a.Points(d,e),y.add(f)}function q(b,c){var d=c.blocks[b.name];if(!d.entities)return null;var e=new a.Object3D;b.xScale&&(e.scale.x=b.xScale),b.yScale&&(e.scale.y=b.yScale),b.rotation&&(e.rotation.z=b.rotation*Math.PI/180),b.position&&(e.position.x=b.position.x,e.position.y=b.position.y,e.position.z=b.position.z);for(var f=0;f<d.entities.length;f++){var g=h(d.entities[f],c,e);g&&e.add(g)}return e}function r(a,b){var c=0;return a.color?c=a.color:b.tables&&b.tables.layer&&b.tables.layer.layers[a.layer]&&(c=b.tables.layer.layers[a.layer].color),null!=c&&16777215!==c||(c=0),c}function s(a){var b,c;if(a.tables&&a.tables.lineType){var d=a.tables.lineType.lineTypes;for(c in d)b=d[c],b.pattern&&(b.material=t(b.pattern))}}function t(b){var c,d={},e=0;for(c=0;c<b.length;c++)e+=Math.abs(b[c]);return d.uniforms=a.UniformsUtils.merge([a.UniformsLib.common,a.UniformsLib.fog,{pattern:{type:"fv1",value:b},patternLength:{type:"f",value:e}}]),d.vertexShader=["attribute float lineDistance;","varying float vLineDistance;",a.ShaderChunk.color_pars_vertex,"void main() {",a.ShaderChunk.color_vertex,"vLineDistance = lineDistance;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),d.fragmentShader=["uniform vec3 diffuse;","uniform float opacity;","uniform float pattern["+b.length+"];","uniform float patternLength;","varying float vLineDistance;",a.ShaderChunk.color_pars_fragment,a.ShaderChunk.fog_pars_fragment,"void main() {","float pos = mod(vLineDistance, patternLength);","for ( int i = 0; i < "+b.length+"; i++ ) {","pos = pos - abs(pattern[i]);","if( pos < 0.0 ) {","if( pattern[i] > 0.0 ) {","gl_FragColor = vec4(1.0, 0.0, 0.0, opacity );","break;","}","discard;","}","}",a.ShaderChunk.color_fragment,a.ShaderChunk.fog_fragment,"}"].join("\n"),d}var u=c(d);s(b);var v,w,x,y=new a.Scene,z={min:{x:!1,y:!1,z:!1},max:{x:!1,y:!1,z:!1}};for(v=0;v<b.entities.length;v++){if(w=b.entities[v],"DIMENSION"===w.type)if(w.block){var A=b.blocks[w.block];if(!A){console.error('Missing referenced block "'+w.block+'"');continue}for(var B=0;B<A.entities.length;B++)x=h(A.entities[B],b)}else console.log("WARNING: No block for DIMENSION entity");else x=h(w,b);if(x){var C=(new a.Box3).setFromObject(x);C.min.x&&(z.min.x===!1||z.min.x>C.min.x)&&(z.min.x=C.min.x),C.min.y&&(z.min.y===!1||z.min.y>C.min.y)&&(z.min.y=C.min.y),C.min.z&&(z.min.z===!1||z.min.z>C.min.z)&&(z.min.z=C.min.z),C.max.x&&(z.max.x===!1||z.max.x<C.max.x)&&(z.max.x=C.max.x),C.max.y&&(z.max.y===!1||z.max.y<C.max.y)&&(z.max.y=C.max.y),C.max.z&&(z.max.z===!1||z.max.z<C.max.z)&&(z.max.z=C.max.z),y.add(x)}x=null}e=e||u.innerWidth(),f=f||u.innerHeight();var D=e/f,E={x:z.max.x,y:z.max.y},F={x:z.min.x,y:z.min.y},G=E.x-F.x,H=E.y-F.y,I=I||{x:G/2+F.x,y:H/2+F.y},J=Math.abs(G/H);D>J?G=H*D:H=G/D;var K={bottom:-H/2,left:-G/2,top:H/2,right:G/2,center:{x:I.x,y:I.y}},L=new a.OrthographicCamera(K.left,K.right,K.top,K.bottom,1,19);L.position.z=10,L.position.x=K.center.x,L.position.y=K.center.y;var M=this.renderer=new a.WebGLRenderer;M.setSize(e,f),M.setClearColor(268435455,1),u.append(M.domElement),u.show();var N=new a.OrbitControls(L,d);N.target.x=L.position.x,N.target.y=L.position.y,N.target.z=0,N.zoomSpeed=3,this.render=function(){M.render(y,L)},N.addEventListener("change",this.render),this.render(),N.update(),u.on("click",function(b){var d=c(M.domElement),e=new a.Vector3((b.pageX-d.offset().left)/d.innerWidth()*2-1,2*-((b.pageY-d.offset().top)/d.innerHeight())+1,.5);e.unproject(L);var f=e.sub(L.position).normalize(),g=-L.position.z/f.z,h=L.position.clone().add(f.multiplyScalar(g));console.log(h.x,h.y)}),this.resize=function(a,b){var c=M.domElement.width,d=M.domElement.height,e=a/c,f=b/d;L.top=f*L.top,L.bottom=f*L.bottom,L.left=e*L.left,L.right=e*L.right,M.setSize(a,b),M.setClearColor(268435455,1),this.render()}},d});